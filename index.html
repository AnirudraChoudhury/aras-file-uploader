<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Upload File to Aras Vault</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="container max-w-xl mx-auto bg-white p-8 rounded-lg shadow-lg">
    <h2 class="text-2xl font-bold text-center text-gray-800 mb-8 border-b-2 border-blue-500 pb-2 flex items-center justify-center gap-2">
      <span>ðŸš€</span> Aras Vault File Uploader
    </h2>
    <div class="mb-4 flex justify-center">
      <span id="statusIndicator" class="inline-block px-4 py-1 rounded-full text-xs font-semibold uppercase bg-green-100 text-green-800">Ready</span>
    </div>
    <div class="mb-6">
      <div class="mb-4 grid grid-cols-1 gap-2">
        <label class="block text-gray-700 font-medium">Base Server URL (e.g. http://localhost/vedanix):
          <input type="text" id="baseServerInput" class="mt-1 block w-full rounded border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50" value="http://localhost/vedanix">
        </label>
        <label class="block text-gray-700 font-medium">Auth Token:
          <input type="text" id="authTokenInput" class="mt-1 block w-full rounded border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50" value="">
        </label>
        <label class="block text-gray-700 font-medium">Vault ID:
          <input type="text" id="vaultIdInput" class="mt-1 block w-full rounded border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50" value="">
        </label>
      </div>
      <div class="mb-4">
        <input type="file" id="fileInput" onchange="showFileInfo()" class="block w-full text-sm text-gray-700 border-2 border-dashed border-blue-400 rounded-lg cursor-pointer bg-blue-50 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-300 transition" />
      </div>
      <div id="fileInfo" class="hidden bg-blue-50 p-3 rounded mb-3">
        <div class="font-semibold">Selected File: <span id="fileName"></span></div>
        <div>Size: <span id="fileSize"></span></div>
        <div>Type: <span id="fileType"></span></div>
      </div>
      <button class="upload-button w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center justify-center gap-2" onclick="uploadFile()" id="uploadBtn">
        <span>ðŸ“¤</span> Upload File
      </button>
    </div>
    <!-- <div class="bg-blue-50 p-3 rounded mb-4">
      <label class="inline-flex items-center">
        <input type="checkbox" id="chunkUpload" checked class="form-checkbox h-5 w-5 text-blue-600">
        <span class="ml-2 text-gray-700 font-medium">Enable Chunked Upload (Recommended for large files)</span>
      </label>
    </div> -->
    <div id="progressSection" class="mb-4 hidden">
      <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
        <div id="progressFill" class="bg-blue-600 h-4 transition-all duration-300" style="width:0%"></div>
      </div>
      <div id="progressText" class="text-center text-blue-700 font-semibold mt-1">0%</div>
    </div>
    <div class="font-semibold text-gray-700 mb-2 flex items-center gap-2"><span>ðŸ“‹</span> Upload Log:</div>
    <pre id="log" class="bg-gray-900 text-green-400 p-3 rounded h-40 overflow-y-auto text-xs leading-relaxed whitespace-pre-wrap">Ready to upload files...</pre>
    <div class="text-center text-gray-400 text-xs mt-6">
      Built with SOLID principles â€¢ Modular Architecture â€¢ Extensible Design
      by <a href="https://anirudrachoudhury.vercel.app" class="text-blue-500 hover:underline">Anirudra Choudhury</a>
    </div>
  </div>
  <!-- Import the refactored JavaScript module -->
  <script src="./js/aras-file-uploader.js"></script>
  <script>
    // Initialize the upload service using the factory
    let uploadService;

    // Show file information when selected
    function showFileInfo() {
      const fileInput = document.getElementById('fileInput');
      const fileInfo = document.getElementById('fileInfo');
      const fileName = document.getElementById('fileName');
      const fileSize = document.getElementById('fileSize');
      const fileType = document.getElementById('fileType');
      
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        fileType.textContent = file.type || 'Unknown';
        fileInfo.style.display = 'block';
        
        // Enable upload button
        document.getElementById('uploadBtn').disabled = false;
      } else {
        fileInfo.style.display = 'none';
        document.getElementById('uploadBtn').disabled = true;
      }
    }

    // Format file size for display
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Update status indicator
    function updateStatus(status, text) {
      const indicator = document.getElementById('statusIndicator');
      indicator.className = `status-indicator status-${status}`;
      indicator.textContent = text;
    }

    // Show/hide progress section
    function toggleProgress(show) {
      const progressSection = document.getElementById('progressSection');
      progressSection.style.display = show ? 'block' : 'none';
    }

    // Update progress bar
    function updateProgress(percent) {
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      
      progressFill.style.width = percent + '%';
      progressText.textContent = Math.round(percent) + '%';
    }

    // Enhanced logger that also updates UI
    class UILogger extends DOMLogger {
      constructor(elementId) {
        super(elementId);
        this.isUploading = false;
      }
      
      log(message) {
        super.log(message);
        
        // Update UI based on log messages
        if (message.includes('Starting upload process')) {
          this.isUploading = true;
          updateStatus('uploading', 'Uploading...');
          toggleProgress(true);
          document.getElementById('uploadBtn').disabled = true;
        } else if (message.includes('Upload completed successfully')) {
          this.isUploading = false;
          updateStatus('success', 'Complete');
          updateProgress(100);
          document.getElementById('uploadBtn').disabled = false;
        } else if (message.includes('Chunk') && message.includes('uploaded successfully')) {
          // Extract progress from chunk messages
          const match = message.match(/Chunk (\d+)\/(\d+)/);
          if (match) {
            const current = parseInt(match[1]);
            const total = parseInt(match[2]);
            const percent = (current / total) * 100;
            updateProgress(percent);
          }
        }
      }
      
      error(message, error) {
        super.error(message, error);
        this.isUploading = false;
        updateStatus('error', 'Error');
        toggleProgress(false);
        document.getElementById('uploadBtn').disabled = false;
      }
    }

    // Override the factory to use our enhanced logger
    const originalCreate = ArasFileUploadServiceFactory.create;
    ArasFileUploadServiceFactory.create = function(baseUrl, vaultUrl, authToken, vaultId, logElementId) {
      const config = new ArasConfig(baseUrl, vaultUrl, authToken, vaultId);
      const logger = new UILogger(logElementId || 'log');
      return new ArasFileUploadService(config, logger);
    };

    // Main upload function - enhanced with UI updates
    async function uploadFile() {
      const fileInput = document.getElementById("fileInput");
      const file = fileInput.files[0];
      const baseServer = document.getElementById('baseServerInput').value;
      const authToken = document.getElementById('authTokenInput').value;
      const vaultId = document.getElementById('vaultIdInput').value;

      if (!file) {
        alert("Please select a file.");
        return;
      }
      if (!baseServer || !authToken || !vaultId) {
        alert("Please fill in all configuration fields.");
        return;
      }

      // Generate URLs from base server
      const baseUrl = baseServer.replace(/\/$/, '') + "/server/odata";
      const vaultUrl = baseServer.replace(/\/$/, '') + "/Vault/odata";

      // Clear previous logs and reset UI
      document.getElementById('log').textContent = '';
      updateProgress(0);
      updateStatus('uploading', 'Preparing...');

      try {
        // Re-initialize service with UI logger and user input
        uploadService = ArasFileUploadServiceFactory.create(
          baseUrl,
          vaultUrl,
          authToken,
          vaultId,
          'log'
        );
        await uploadService.uploadFile(file);
      } catch (error) {
        console.error('Upload failed:', error);
        updateStatus('error', 'Failed');
        toggleProgress(false);
      }
    }

    // Utility function to demonstrate extensibility
    function generateGuid() {
      return GuidGenerator.generate();
    }

    // Initialize UI on load
    document.addEventListener('DOMContentLoaded', function() {
      // Initially disable upload button
      document.getElementById('uploadBtn').disabled = true;
      
      // Add drag and drop functionality
      const fileInput = document.getElementById('fileInput');
      const container = document.querySelector('.container');
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        container.addEventListener(eventName, preventDefaults, false);
      });
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      ['dragenter', 'dragover'].forEach(eventName => {
        container.addEventListener(eventName, highlight, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        container.addEventListener(eventName, unhighlight, false);
      });
      
      function highlight(e) {
        container.style.backgroundColor = '#e7f3ff';
      }
      
      function unhighlight(e) {
        container.style.backgroundColor = 'white';
      }
      
      container.addEventListener('drop', handleDrop, false);
      
      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
          fileInput.files = files;
          showFileInfo();
        }
      }
    });
  </script>
</body>
</html>
